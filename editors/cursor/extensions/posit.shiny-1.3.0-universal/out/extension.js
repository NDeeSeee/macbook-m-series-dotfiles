"use strict";var gr=Object.create;var Se=Object.defineProperty;var vr=Object.getOwnPropertyDescriptor;var wr=Object.getOwnPropertyNames;var yr=Object.getPrototypeOf,Tr=Object.prototype.hasOwnProperty;var Pe=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports),Er=(n,t)=>{for(var e in t)Se(n,e,{get:t[e],enumerable:!0})},At=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of wr(t))!Tr.call(n,i)&&i!==e&&Se(n,i,{get:()=>t[i],enumerable:!(r=vr(t,i))||r.enumerable});return n};var _=(n,t,e)=>(e=n!=null?gr(yr(n)):{},At(t||!n||!n.__esModule?Se(e,"default",{value:n,enumerable:!0}):e,n)),xr=n=>At(Se({},"__esModule",{value:!0}),n);var rn=Pe(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});var Ie=new Function("return this")().Promise,rt=!1;try{rt=new Function("return (async function(){}).constructor")()}catch(n){if(!(n instanceof SyntaxError))throw n}function Vt(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function Te(n,t,e){for(var r in t)Vt(t,r)&&(t[r]!=null&&typeof t[r]=="object"&&(r==="storage"||r==="prefixes")&&!e?n[r]=Te({},t[r]):n[r]=t[r]);return n}function Fr(n,t,e,r){var i,o;return typeof t.autoTrim=="string"?i=o=t.autoTrim:Array.isArray(t.autoTrim)&&(i=t.autoTrim[1],o=t.autoTrim[0]),(e||e===!1)&&(i=e),(r||r===!1)&&(o=r),i==="slurp"&&o==="slurp"?n.trim():(i==="_"||i==="slurp"?String.prototype.trimLeft?n=n.trimLeft():n=n.replace(/^[\s\uFEFF\xA0]+/,""):(i==="-"||i==="nl")&&(n=n.replace(/^(?:\n|\r|\r\n)/,"")),o==="_"||o==="slurp"?String.prototype.trimRight?n=n.trimRight():n=n.replace(/[\s\uFEFF\xA0]+$/,""):(o==="-"||o==="nl")&&(n=n.replace(/(?:\n|\r|\r\n)$/,"")),n)}function Cr(n){return/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n)}var Le=function(){function n(t){this.cache=t}return n.prototype.define=function(t,e){this.cache[t]=e},n.prototype.get=function(t){return this.cache[t]},n.prototype.remove=function(t){delete this.cache[t]},n.prototype.reset=function(){this.cache={}},n.prototype.load=function(t){Te(this.cache,t,!0)},n}();function Nr(n,t){Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t}function A(n){var t=new Error(n);return Nr(t,A.prototype),t}A.prototype=Object.create(Error.prototype,{name:{value:"Squirrelly Error",enumerable:!1}});function J(n,t,e){var r=t.slice(0,e).split(/\n/),i=r.length,o=r[i-1].length+1;throw n+=" at line "+i+" col "+o+`:

  `+t.split(/\n/)[i-1]+`
  `+Array(o).join(" ")+"^",A(n)}var X=/^async +/,Ae=/`(?:\\[\s\S]|\${(?:[^{}]|{(?:[^{}]|{[^}]*})*})*}|(?!\${)[^\\`])*`/g,ke=/'(?:\\[\s\w"'\\`]|[^\n\r'\\])*?'/g,De=/"(?:\\[\s\w"'\\`]|[^\n\r"\\])*?"/g,Gt=/[.*+\-?^${}()|[\]\\]/g;function Oe(n){return Gt.test(n)?n.replace(Gt,"\\$&"):n}function Kt(n,t){t.rmWhitespace&&(n=n.replace(/[\r\n]+/g,`
`).replace(/^\s+|\s+$/gm,"")),Ae.lastIndex=0,ke.lastIndex=0,De.lastIndex=0;var e=t.prefixes,r=[e.h,e.b,e.i,e.r,e.c,e.e].reduce(function(m,S){return m&&S?m+"|"+Oe(S):S?Oe(S):m},""),i=new RegExp("([|()]|=>)|('|\"|`|\\/\\*)|\\s*((\\/)?(-|_)?"+Oe(t.tags[1])+")","g"),o=new RegExp("([^]*?)"+Oe(t.tags[0])+"(-|_)?\\s*("+r+")?\\s*","g"),s=0,a=!1;function l(m,S){var E={f:[]},y=0,R="c";S==="h"||S==="b"||S==="c"?R="n":S==="r"&&(E.raw=!0,S="i");function v(V){var ae=n.slice(s,V),j=ae.trim();if(R==="f")j==="safe"?E.raw=!0:t.async&&X.test(j)?(j=j.replace(X,""),E.f.push([j,"",!0])):E.f.push([j,""]);else if(R==="fp")E.f[E.f.length-1][1]+=j;else if(R==="err"){if(j){var le=ae.search(/\S/);J("invalid syntax",n,s+le)}}else E[R]=j;s=V+1}i.lastIndex=s;for(var w;(w=i.exec(n))!==null;){var h=w[1],u=w[2],P=w[3],T=w[4],N=w[5],b=w.index;if(h)h==="("?(y===0&&(R==="n"?(v(b),R="p"):R==="f"&&(v(b),R="fp")),y++):h===")"?(y--,y===0&&R!=="c"&&(v(b),R="err")):y===0&&h==="|"?(v(b),R="f"):h==="=>"&&(v(b),s+=1,R="res");else if(u){if(u==="/*"){var Y=n.indexOf("*/",i.lastIndex);Y===-1&&J("unclosed comment",n,w.index),i.lastIndex=Y+2}else if(u==="'"){ke.lastIndex=w.index;var G=ke.exec(n);G?i.lastIndex=ke.lastIndex:J("unclosed string",n,w.index)}else if(u==='"'){De.lastIndex=w.index;var O=De.exec(n);O?i.lastIndex=De.lastIndex:J("unclosed string",n,w.index)}else if(u==="`"){Ae.lastIndex=w.index;var L=Ae.exec(n);L?i.lastIndex=Ae.lastIndex:J("unclosed string",n,w.index)}}else if(P)return v(b),s=b+w[0].length,o.lastIndex=s,a=N,T&&S==="h"&&(S="s"),E.t=S,E}return J("unclosed tag",n,m),E}function c(m,S){m.b=[],m.d=[];var E=!1,y=[];function R(L,V){L&&(L=Fr(L,t,a,V),L&&(L=L.replace(/\\|'/g,"\\$&").replace(/\r\n|\n|\r/g,"\\n"),y.push(L)))}for(var v;(v=o.exec(n))!==null;){var w=v[1],h=v[2],u=v[3]||"",P;for(var T in e)if(e[T]===u){P=T;break}R(w,h),s=v.index+v[0].length,P||J("unrecognized tag type: "+u,n,s);var N=l(v.index,P),b=N.t;if(b==="h"){var Y=N.n||"";t.async&&X.test(Y)&&(N.a=!0,N.n=Y.replace(X,"")),N=c(N),y.push(N)}else if(b==="c"){if(m.n===N.n)return E?(E.d=y,m.b.push(E)):m.d=y,m;J("Helper start and end don't match",n,v.index+v[0].length)}else if(b==="b"){E?(E.d=y,m.b.push(E)):m.d=y;var G=N.n||"";t.async&&X.test(G)&&(N.a=!0,N.n=G.replace(X,"")),E=N,y=[]}else if(b==="s"){var O=N.n||"";t.async&&X.test(O)&&(N.a=!0,N.n=O.replace(X,"")),y.push(N)}else y.push(N)}if(S)R(n.slice(s,n.length),!1),m.d=y;else throw A('unclosed helper "'+m.n+'"');return m}var p=c({f:[]},!0);if(t.plugins)for(var f=0;f<t.plugins.length;f++){var g=t.plugins[f];g.processAST&&(p.d=g.processAST(p.d,t))}return p.d}function it(n,t){var e=Kt(n,t),r="var tR='';"+(t.useWith?"with("+t.varName+"||{}){":"")+Z(e,t)+"if(cb){cb(null,tR)} return tR"+(t.useWith?"}":"");if(t.plugins)for(var i=0;i<t.plugins.length;i++){var o=t.plugins[i];o.processFnString&&(r=o.processFnString(r,t))}return r}function ze(n,t){for(var e=0;e<t.length;e++){var r=t[e][0],i=t[e][1],o=t[e][2];n=(o?"await ":"")+"c.l('F','"+r+"')("+n,i&&(n+=","+i),n+=")"}return n}function Yt(n,t,e,r,i,o){var s="{exec:"+(i?"async ":"")+at(e,t,n)+",params:["+r+"]";return o&&(s+=",name:'"+o+"'"),i&&(s+=",async:true"),s+="}",s}function br(n,t){for(var e="[",r=0;r<n.length;r++){var i=n[r];e+=Yt(t,i.res||"",i.d,i.p||"",i.a,i.n),r<n.length&&(e+=",")}return e+="]",e}function at(n,t,e){return"function("+t+"){var tR='';"+Z(n,e)+"return tR}"}function Z(n,t){var e=0,r=n.length,i="";for(e;e<r;e++){var o=n[e];if(typeof o=="string"){var s=o;i+="tR+='"+s+"';"}else{var a=o.t,l=o.c||"",c=o.f,p=o.n||"",f=o.p||"",g=o.res||"",m=o.b,S=!!o.a;if(a==="i"){t.defaultFilter&&(l="c.l('F','"+t.defaultFilter+"')("+l+")");var E=ze(l,c);!o.raw&&t.autoEscape&&(E="c.l('F','e')("+E+")"),i+="tR+="+E+";"}else if(a==="h")if(t.storage.nativeHelpers.get(p))i+=t.storage.nativeHelpers.get(p)(o,t);else{var y=(S?"await ":"")+"c.l('H','"+p+"')("+Yt(t,g,o.d,f,S);m?y+=","+br(m,t):y+=",[]",y+=",c)",i+="tR+="+ze(y,c)+";"}else a==="s"?i+="tR+="+ze((S?"await ":"")+"c.l('H','"+p+"')({params:["+f+"]},[],c)",c)+";":a==="e"&&(i+=l+`
`)}}return i}function ie(n,t,e,r){if(t&&t.length>0)throw A((r?"Native":"")+"Helper '"+n+"' doesn't accept blocks");if(e&&e.length>0)throw A((r?"Native":"")+"Helper '"+n+"' doesn't accept filters")}function qt(n,t,e,r,i){e(n[t],t).then(function(o){r+=o,t===n.length-1?i(r):qt(n,t+1,e,r,i)})}function Jt(n,t,e,r,i,o){r(t[e],n[t[e]]).then(function(s){i+=s,e===t.length-1?o(i):Jt(n,t,e+1,r,i,o)})}var Ar={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function kr(n){return Ar[n]}function Dr(n){var t=String(n);return/[&<>"']/.test(t)?t.replace(/[&<>"']/g,kr):t}var Xt=new Le({}),Me=new Le({each:function(n,t){var e="",r=n.params[0];if(ie("each",t,!1),n.async)return new Promise(function(o){qt(r,0,n.exec,e,o)});for(var i=0;i<r.length;i++)e+=n.exec(r[i],i);return e},foreach:function(n,t){var e=n.params[0];if(ie("foreach",t,!1),n.async)return new Promise(function(o){Jt(e,Object.keys(e),0,n.exec,"",o)});var r="";for(var i in e)Vt(e,i)&&(r+=n.exec(i,e[i]));return r},include:function(n,t,e){ie("include",t,!1);var r=e.storage.templates.get(n.params[0]);if(!r)throw A('Could not fetch template "'+n.params[0]+'"');return r(n.params[1],e)},extends:function(n,t,e){var r=n.params[1]||{};r.content=n.exec();for(var i=0;i<t.length;i++){var o=t[i];r[o.name]=o.exec()}var s=e.storage.templates.get(n.params[0]);if(!s)throw A('Could not fetch template "'+n.params[0]+'"');return s(r,e)},useScope:function(n,t){return ie("useScope",t,!1),n.exec(n.params[0])}}),Zt=new Le({if:function(n,t){ie("if",!1,n.f,!0);var e="if("+n.p+"){"+Z(n.d,t)+"}";if(n.b)for(var r=0;r<n.b.length;r++){var i=n.b[r];i.n==="else"?e+="else{"+Z(i.d,t)+"}":i.n==="elif"&&(e+="else if("+i.p+"){"+Z(i.d,t)+"}")}return e},try:function(n,t){if(ie("try",!1,n.f,!0),!n.b||n.b.length!==1||n.b[0].n!=="catch")throw A("native helper 'try' only accepts 1 block, 'catch'");var e="try{"+Z(n.d,t)+"}",r=n.b[0];return e+="catch"+(r.res?"("+r.res+")":"")+"{"+Z(r.d,t)+"}",e},block:function(n,t){ie("block",n.b,n.f,!0);var e="if(!"+t.varName+"["+n.p+"]){tR+=("+at(n.d,"",t)+")()}else{tR+="+t.varName+"["+n.p+"]}";return e}}),Qt=new Le({e:Dr}),Ue={varName:"it",autoTrim:[!1,"nl"],autoEscape:!0,defaultFilter:!1,tags:["{{","}}"],l:function(n,t){if(n==="H"){var e=this.storage.helpers.get(t);if(e)return e;throw A("Can't find helper '"+t+"'")}else if(n==="F"){var r=this.storage.filters.get(t);if(r)return r;throw A("Can't find filter '"+t+"'")}},async:!1,storage:{helpers:Me,nativeHelpers:Zt,filters:Qt,templates:Xt},prefixes:{h:"@",b:"#",i:"",r:"*",c:"/",e:"!"},cache:!1,plugins:[],useWith:!1};Ue.l.bind(Ue);function ce(n,t){var e={};return Te(e,Ue),t&&Te(e,t),n&&Te(e,n),e.l.bind(e),e}function $e(n,t){var e=ce(t||{}),r=Function;if(e.async)if(rt)r=rt;else throw A("This environment doesn't support async/await");if(e.varName&&Cr(e.varName)===!1)throw A("options.varName must be a valid JS identifier");try{return new r(e.varName,"c","cb",it(n,e))}catch(i){throw i instanceof SyntaxError?A(`Bad template syntax

`+i.message+`
`+Array(i.message.length+1).join("=")+`
`+it(n,e)):i}}var ot=require("fs"),et=require("path"),Or=/^\uFEFF/;function tt(n,t,e){var r=et.resolve(e?t:et.dirname(t),n),i=et.extname(n);return i||(r+=".sqrl"),r}function Ir(n,t){var e,r,i=t.views,o=/^[A-Za-z]+:\\|^\//.exec(n);if(o&&o.length)e=tt(n.replace(/^\/*/,""),t.root||"/",!0);else if(t.filename&&(r=tt(n,t.filename),ot.existsSync(r)&&(e=r)),e||Array.isArray(i)&&i.some(function(s){return r=tt(n,s,!0),ot.existsSync(r)})&&(e=r),!e)throw A('Could not find the include file "'+n+'"');return e}function zt(n){return ot.readFileSync(n).toString().replace(Or,"")}function en(n,t){var e=ce(t),r=zt(n);try{var i=$e(r,e);return e.storage.templates.define(e.filename,i),i}catch{throw A("Loading file: "+n+" failed")}}function st(n){var t=n.filename;if(n.cache){var e=n.storage.templates.get(t);return e||en(t,n)}return $e(zt(t),n)}function Ur(n,t,e){var r;if(e)try{st(n)(t,n,e)}catch(i){return e(i)}else{if(typeof Ie=="function")return new Ie(function(i,o){try{r=st(n)(t,n),i(r)}catch(s){o(s)}});throw A("Please provide a callback function, this env doesn't support Promises")}}function tn(n,t){var e=ce({filename:Ir(n,t)},t);return st(e)}function nn(n,t,e){t=t||{};var r=ce(t);return r.filename=n,Ur(r,t,e)}function Lr(n,t,e){if(t&&t.length>0)throw A("Helper 'includeFile' doesn't accept blocks");return tn(n.params[0],e)(n.params[1],e)}function Mr(n,t,e){var r=n.params[1]||{};r.content=n.exec();for(var i=0;i<t.length;i++){var o=t[i];r[o.name]=o.exec()}return tn(n.params[0],e)(r,e)}function nt(n,t){var e;return t.cache&&t.name&&t.storage.templates.get(t.name)?t.storage.templates.get(t.name):(typeof n=="function"?e=n:e=$e(n,t),t.cache&&t.name&&t.storage.templates.define(t.name,e),e)}function $r(n,t,e,r){var i=ce(e||{});if(i.async){var o;if(r)try{nt(n,i)(t,i,r)}catch(s){return r(s)}else{if(typeof Ie=="function")return new Ie(function(s,a){try{o=nt(n,i)(t,i),s(o)}catch(l){a(l)}});throw A("Please provide a callback function, this env doesn't support Promises")}}else return nt(n,i)(t,i)}Me.define("includeFile",Lr);Me.define("extendsFile",Mr);I.__express=nn;I.compile=$e;I.compileScope=Z;I.compileScopeIntoFunction=at;I.compileToString=it;I.defaultConfig=Ue;I.filters=Qt;I.getConfig=ce;I.helpers=Me;I.loadFile=en;I.nativeHelpers=Zt;I.parse=Kt;I.render=$r;I.renderFile=nn;I.templates=Xt});var ln=Pe(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.PythonExtension=Q.PVSC_EXTENSION_ID=void 0;var Vr=require("vscode");Q.PVSC_EXTENSION_ID="ms-python.python";var Kr;(function(n){async function t(){let e=Vr.extensions.getExtension(Q.PVSC_EXTENSION_ID);if(e===void 0)throw new Error("Python extension is not installed or is disabled");return e.isActive||await e.activate(),e.exports}n.api=t})(Kr=Q.PythonExtension||(Q.PythonExtension={}))});var Pn=Pe((lo,Sn)=>{var ct=require("util"),Yr=require("path"),z=require("child_process").spawn,M=function(){},pt="HKLM",cn="HKCU",pn="HKCR",un="HKU",fn="HKCC",dn=[pt,cn,pn,un,fn],hn="REG_SZ",mn="REG_MULTI_SZ",gn="REG_EXPAND_SZ",vn="REG_DWORD",wn="REG_QWORD",yn="REG_BINARY",Tn="REG_NONE",En=[hn,mn,gn,vn,wn,yn,Tn],qr="",Jr=/(\\[a-zA-Z0-9_\s]+)*/,Xr=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,xn=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function ue(n,t){if(!(this instanceof ue))return new ue(n,t);Error.captureStackTrace(this,ue),this.__defineGetter__("name",function(){return ue.name}),this.__defineGetter__("message",function(){return n}),this.__defineGetter__("code",function(){return t})}ct.inherits(ue,Error);function ee(n){var t={stdout:"",stderr:""};return n.stdout.on("data",function(e){t.stdout+=e.toString()}),n.stderr.on("data",function(e){t.stderr+=e.toString()}),t}function te(n,t,e){var r=e.stdout.trim(),i=e.stderr.trim(),o=ct.format(`%s command exited with code %d:
%s
%s`,n,t,r,i);return new ue(o,t)}function Zr(n){if(n=="x64")return"64";if(n=="x86")return"32";throw new Error("illegal architecture: "+n+" (use x86 or x64)")}function ne(n,t){t&&n.push("/reg:"+Zr(t))}function re(){return process.platform==="win32"?Yr.join(process.env.windir,"system32","reg.exe"):"REG"}function Ee(n,t,e,r,i,o,s){if(!(this instanceof Ee))return new Ee(n,t,e,r,i,o,s);var a=n,l=t,c=e,p=r,f=i,g=o,m=s;this.__defineGetter__("host",function(){return a}),this.__defineGetter__("hive",function(){return l}),this.__defineGetter__("key",function(){return c}),this.__defineGetter__("name",function(){return p}),this.__defineGetter__("type",function(){return f}),this.__defineGetter__("value",function(){return g}),this.__defineGetter__("arch",function(){return m})}ct.inherits(Ee,Object);function F(n){if(!(this instanceof F))return new F(n);var t=n||{},e=""+(t.host||""),r=""+(t.hive||pt),i=""+(t.key||""),o=t.arch||null;if(this.__defineGetter__("host",function(){return e}),this.__defineGetter__("hive",function(){return r}),this.__defineGetter__("key",function(){return i}),this.__defineGetter__("path",function(){return'"'+(e.length==0?"":"\\\\"+e+"\\")+r+i+'"'}),this.__defineGetter__("arch",function(){return o}),this.__defineGetter__("parent",function(){var s=i.lastIndexOf("\\");return new F({host:this.host,hive:this.hive,key:s==-1?"":i.substring(0,s),arch:this.arch})}),dn.indexOf(r)==-1)throw new Error("illegal hive specified.");if(!Jr.test(i))throw new Error("illegal key specified.");if(o&&o!="x64"&&o!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}F.HKLM=pt;F.HKCU=cn;F.HKCR=pn;F.HKU=un;F.HKCC=fn;F.HIVES=dn;F.REG_SZ=hn;F.REG_MULTI_SZ=mn;F.REG_EXPAND_SZ=gn;F.REG_DWORD=vn;F.REG_QWORD=wn;F.REG_BINARY=yn;F.REG_NONE=Tn;F.REG_TYPES=En;F.DEFAULT_VALUE=qr;F.prototype.values=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["QUERY",this.path];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i="",o=this,s=null,a=ee(r);return r.on("close",function(l){if(!s)if(l!==0)M("process exited with code "+l),t(te("QUERY",l,a),null);else{for(var c=[],p=[],f=i.split(`
`),g=0,m=0,S=f.length;m<S;m++){var E=f[m].trim();E.length>0&&(M(E),g!=0&&c.push(E),++g)}for(var m=0,S=c.length;m<S;m++){var y=xn.exec(c[m]),R,v,w;y&&(R=y[1].trim(),v=y[2].trim(),w=y[3],p.push(new Ee(o.host,o.hive,o.key,R,v,w,o.arch)))}t(null,p)}}),r.stdout.on("data",function(l){i+=l.toString()}),r.on("error",function(l){s=l,t(l)}),this};F.prototype.keys=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["QUERY",this.path];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i="",o=this,s=null,a=ee(r);return r.on("close",function(l){s||l!==0&&(M("process exited with code "+l),t(te("QUERY",l,a),null))}),r.stdout.on("data",function(l){i+=l.toString()}),r.stdout.on("end",function(){for(var l=[],c=[],p=i.split(`
`),f=0,g=p.length;f<g;f++){var m=p[f].trim();m.length>0&&(M(m),l.push(m))}for(var f=0,g=l.length;f<g;f++){var S=Xr.exec(l[f]),E,y;S&&(E=S[1],y=S[2],y&&y!==o.key&&c.push(new F({host:o.host,hive:o.hive,key:y,arch:o.arch})))}t(null,c)}),r.on("error",function(l){s=l,t(l)}),this};F.prototype.get=function(t,e){if(typeof e!="function")throw new TypeError("must specify a callback");var r=["QUERY",this.path];t==""?r.push("/ve"):r=r.concat(["/v",t]),ne(r,this.arch);var i=z(re(),r,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),o="",s=this,a=null,l=ee(i);return i.on("close",function(c){if(!a)if(c!==0)M("process exited with code "+c),e(te("QUERY",c,l),null);else{for(var p=[],f=null,g=o.split(`
`),m=0,S=0,E=g.length;S<E;S++){var y=g[S].trim();y.length>0&&(M(y),m!=0&&p.push(y),++m)}var R=p[p.length-1]||"",v=xn.exec(R),w,h,u;v&&(w=v[1].trim(),h=v[2].trim(),u=v[3],f=new Ee(s.host,s.hive,s.key,w,h,u,s.arch)),e(null,f)}}),i.stdout.on("data",function(c){o+=c.toString()}),i.on("error",function(c){a=c,e(c)}),this};F.prototype.set=function(t,e,r,i){if(typeof i!="function")throw new TypeError("must specify a callback");if(En.indexOf(e)==-1)throw Error("illegal type specified.");var o=["ADD",this.path];t==""?o.push("/ve"):o=o.concat(["/v",t]),o=o.concat(["/t",e,"/d",r,"/f"]),ne(o,this.arch);var s=z(re(),o,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),a=null,l=ee(s);return s.on("close",function(c){a||(c!==0?(M("process exited with code "+c),i(te("ADD",c,l,null))):i(null))}),s.stdout.on("data",function(c){M(""+c)}),s.on("error",function(c){a=c,i(c)}),this};F.prototype.remove=function(t,e){if(typeof e!="function")throw new TypeError("must specify a callback");var r=t?["DELETE",this.path,"/f","/v",t]:["DELETE",this.path,"/f","/ve"];ne(r,this.arch);var i=z(re(),r,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),o=null,s=ee(i);return i.on("close",function(a){o||(a!==0?(M("process exited with code "+a),e(te("DELETE",a,s),null)):e(null))}),i.stdout.on("data",function(a){M(""+a)}),i.on("error",function(a){o=a,e(a)}),this};F.prototype.clear=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["DELETE",this.path,"/f","/va"];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i=null,o=ee(r);return r.on("close",function(s){i||(s!==0?(M("process exited with code "+s),t(te("DELETE",s,o),null)):t(null))}),r.stdout.on("data",function(s){M(""+s)}),r.on("error",function(s){i=s,t(s)}),this};F.prototype.erase=F.prototype.clear;F.prototype.destroy=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["DELETE",this.path,"/f"];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i=null,o=ee(r);return r.on("close",function(s){i||(s!==0?(M("process exited with code "+s),t(te("DELETE",s,o),null)):t(null))}),r.stdout.on("data",function(s){M(""+s)}),r.on("error",function(s){i=s,t(s)}),this};F.prototype.create=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["ADD",this.path,"/f"];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i=null,o=ee(r);return r.on("close",function(s){i||(s!==0?(M("process exited with code "+s),t(te("ADD",s,o),null)):t(null))}),r.stdout.on("data",function(s){M(""+s)}),r.on("error",function(s){i=s,t(s)}),this};F.prototype.keyExists=function(t){return this.values(function(e,r){if(e)return e.code==1?t(null,!1):t(e);t(null,!0)}),this};F.prototype.valueExists=function(t,e){return this.get(t,function(r,i){if(r)return r.code==1?e(null,!1):e(r);e(null,!0)}),this};Sn.exports=F});var ar=Pe((ns,Je)=>{var _t=function(){var n=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",r={};function i(s,a){if(!r[s]){r[s]={};for(var l=0;l<s.length;l++)r[s][s.charAt(l)]=l}return r[s][a]}var o={compressToBase64:function(s){if(s==null)return"";var a=o._compress(s,6,function(l){return t.charAt(l)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(s){return s==null?"":s==""?null:o._decompress(s.length,32,function(a){return i(t,s.charAt(a))})},compressToUTF16:function(s){return s==null?"":o._compress(s,15,function(a){return n(a+32)})+" "},decompressFromUTF16:function(s){return s==null?"":s==""?null:o._decompress(s.length,16384,function(a){return s.charCodeAt(a)-32})},compressToUint8Array:function(s){for(var a=o.compress(s),l=new Uint8Array(a.length*2),c=0,p=a.length;c<p;c++){var f=a.charCodeAt(c);l[c*2]=f>>>8,l[c*2+1]=f%256}return l},decompressFromUint8Array:function(s){if(s==null)return o.decompress(s);for(var a=new Array(s.length/2),l=0,c=a.length;l<c;l++)a[l]=s[l*2]*256+s[l*2+1];var p=[];return a.forEach(function(f){p.push(n(f))}),o.decompress(p.join(""))},compressToEncodedURIComponent:function(s){return s==null?"":o._compress(s,6,function(a){return e.charAt(a)})},decompressFromEncodedURIComponent:function(s){return s==null?"":s==""?null:(s=s.replace(/ /g,"+"),o._decompress(s.length,32,function(a){return i(e,s.charAt(a))}))},compress:function(s){return o._compress(s,16,function(a){return n(a)})},_compress:function(s,a,l){if(s==null)return"";var c,p,f={},g={},m="",S="",E="",y=2,R=3,v=2,w=[],h=0,u=0,P;for(P=0;P<s.length;P+=1)if(m=s.charAt(P),Object.prototype.hasOwnProperty.call(f,m)||(f[m]=R++,g[m]=!0),S=E+m,Object.prototype.hasOwnProperty.call(f,S))E=S;else{if(Object.prototype.hasOwnProperty.call(g,E)){if(E.charCodeAt(0)<256){for(c=0;c<v;c++)h=h<<1,u==a-1?(u=0,w.push(l(h)),h=0):u++;for(p=E.charCodeAt(0),c=0;c<8;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1}else{for(p=1,c=0;c<v;c++)h=h<<1|p,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=0;for(p=E.charCodeAt(0),c=0;c<16;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1}y--,y==0&&(y=Math.pow(2,v),v++),delete g[E]}else for(p=f[E],c=0;c<v;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1;y--,y==0&&(y=Math.pow(2,v),v++),f[S]=R++,E=String(m)}if(E!==""){if(Object.prototype.hasOwnProperty.call(g,E)){if(E.charCodeAt(0)<256){for(c=0;c<v;c++)h=h<<1,u==a-1?(u=0,w.push(l(h)),h=0):u++;for(p=E.charCodeAt(0),c=0;c<8;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1}else{for(p=1,c=0;c<v;c++)h=h<<1|p,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=0;for(p=E.charCodeAt(0),c=0;c<16;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1}y--,y==0&&(y=Math.pow(2,v),v++),delete g[E]}else for(p=f[E],c=0;c<v;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1;y--,y==0&&(y=Math.pow(2,v),v++)}for(p=2,c=0;c<v;c++)h=h<<1|p&1,u==a-1?(u=0,w.push(l(h)),h=0):u++,p=p>>1;for(;;)if(h=h<<1,u==a-1){w.push(l(h));break}else u++;return w.join("")},decompress:function(s){return s==null?"":s==""?null:o._decompress(s.length,32768,function(a){return s.charCodeAt(a)})},_decompress:function(s,a,l){var c=[],p,f=4,g=4,m=3,S="",E=[],y,R,v,w,h,u,P,T={val:l(0),position:a,index:1};for(y=0;y<3;y+=1)c[y]=y;for(v=0,h=Math.pow(2,2),u=1;u!=h;)w=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(w>0?1:0)*u,u<<=1;switch(p=v){case 0:for(v=0,h=Math.pow(2,8),u=1;u!=h;)w=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(w>0?1:0)*u,u<<=1;P=n(v);break;case 1:for(v=0,h=Math.pow(2,16),u=1;u!=h;)w=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(w>0?1:0)*u,u<<=1;P=n(v);break;case 2:return""}for(c[3]=P,R=P,E.push(P);;){if(T.index>s)return"";for(v=0,h=Math.pow(2,m),u=1;u!=h;)w=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(w>0?1:0)*u,u<<=1;switch(P=v){case 0:for(v=0,h=Math.pow(2,8),u=1;u!=h;)w=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(w>0?1:0)*u,u<<=1;c[g++]=n(v),P=g-1,f--;break;case 1:for(v=0,h=Math.pow(2,16),u=1;u!=h;)w=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(w>0?1:0)*u,u<<=1;c[g++]=n(v),P=g-1,f--;break;case 2:return E.join("")}if(f==0&&(f=Math.pow(2,m),m++),c[P])S=c[P];else if(P===g)S=R+R.charAt(0);else return null;E.push(S),c[g++]=R+S.charAt(0),f--,R=S,f==0&&(f=Math.pow(2,m),m++)}}};return o}();typeof define=="function"&&define.amd?define(function(){return _t}):typeof Je<"u"&&Je!=null?Je.exports=_t:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return _t})});var ji={};Er(ji,{activate:()=>Mi,deactivate:()=>$i,isShinyAppFilename:()=>H,isShinyAppRPart:()=>Ke});module.exports=xr(ji);var bt=_(require("path")),D=_(require("vscode"));var W=_(require("path")),d=_(require("vscode"));var kt=_(require("vscode"));function Dt(){let n=Qe();if(n)return t=>n.window.previewUrl(kt.Uri.parse(t))}async function Ot(n){let t=Qe();if(t)return await t.runtime.getPreferredRuntime(n)}function Qe(){if(typeof globalThis?.acquirePositronApi=="function")return globalThis.acquirePositronApi()}function we(){return Qe()!==void 0}var It={r:{name:"r",properName:"R",fileExt:"R"},python:{name:"python",properName:"Python",fileExt:"py"}};function Ut(n){switch(n.slice(n.lastIndexOf(".")).toLowerCase()){case".py":return"python";case".r":return"r";default:return"text"}}function Re(n){return It[n].fileExt}function q(n){return It[n].properName}function Lt(n){return!!n.name.match(/claude .*sonnet/i)}function Mt(n,t){we()?(t.markdown(`It looks like you are using **${n}** for Copilot. `),t.markdown(`For best results with \`@shiny\`, please switch to **${ye()}**.

`)):(t.markdown(`It looks like you are using **${n}** for Copilot. `),t.markdown(`For best results with \`@shiny\`, please switch to **${ye()}**.

`)),t.button({title:`I'll switch to ${ye()}`,command:"shiny.assistant.continueAfterDesiredModelSuggestion",arguments:[!0]}),t.button({title:`No thanks, I'll continue with ${n}`,command:"shiny.assistant.continueAfterDesiredModelSuggestion",arguments:[!1]})}function ye(){return we()?"Claude 4 Sonnet":"Claude Sonnet 4"}var $t=_(require("path")),_e=class{files={};addFiles(t,e=null){for(let r of t)this.addFile(r,e)}addFile(t,e=null){if(t.type==="binary")throw new Error(`Binary files are not supported by ProposedFilePreviewProvider at this time: ${t.name}`);let r={...t};e&&(r.name=$t.join(e,t.name)),this.files[r.name]=r}provideTextDocumentContent(t){if(t.path.startsWith("/empty/"))return"";let e=this.files[t.path];return e?e.content:""}};var Bt=_(require("vscode"));var Wt=_(require("path")),Fe=_(require("vscode"));function jt(n){return n.replace(/\s+$/,"")}function Sr(n,t,e=!0){if(t==="")return{status:"success",value:n};let r=Rr(t);if(!(r instanceof Array))return r;let i=n.split(`
`),o=[],s=0;for(let a of r)if(a.old.length>0){let l=!1;for(let c=s;c<=i.length-a.old.length;c++){let p=!0;for(let f=0;f<a.old.length;f++){let g=i[c+f],m=a.old[f];if(e&&(g=jt(g),m=jt(m)),g!==m){p=!1;break}}if(p){for(;s<c;)o.push(i[s]),s++;for(let f of a.new)o.push(f);s+=a.old.length,l=!0;break}}if(!l)return console.log(`Could not find search pattern in chunk: ${a.old.join(`
`)}`),console.log(`Original: ${i.join(`
`)}`),{status:"error",message:"Could not find search pattern in chunk",extra:{pattern:a.old.join(`
`)}}}for(;s<i.length;)o.push(i[s]),s++;return{status:"success",value:o.join(`
`)}}async function Pr(n,t){let r=(await Fe.workspace.fs.readFile(Fe.Uri.file(t))).toString(),i=Sr(r,n);return i.status==="error"&&(i.extra.fileName=t),i}async function Ht(n,t){let e={format:"complete",files:[]},r=[];for(let i of n.files){if(i.type==="binary"){r.push({status:"error",message:`Diff for binary file ${i.name} is not supported.`,extra:{filename:i.name}});continue}let o=await Pr(i.content,Wt.join(t,i.name));if(o.status==="success"){let s={name:i.name,content:o.value,type:"text"};e.files.push(s)}else o.status==="error"&&r.push(o)}return{fileSet:e,diffErrors:r}}function Rr(n){let t=[],e=n.split(`
`),r=null;e.length>=2&&e[0].startsWith("---")&&e[1].startsWith("+++")&&(e.shift(),e.shift());for(let i of e)if(i==="@@ ... @@")r&&t.push(r),r={old:[],new:[]};else if(r){let o=i.slice(1);switch(i[0]){case"-":r.old.push(o);break;case"+":r.new.push(o);break;case" ":r.old.push(o),r.new.push(o);break;case void 0:r.old.push(""),r.new.push("");break;default:return{status:"error",message:`Unknown line type: ${i[0]}`,extra:{}}}}else return{status:"error",message:`Invalid diff format: ${i}`,extra:{}};return r&&t.push(r),t}var Ce=class{currentState;states;constructor({initialState:t,states:e}){this.currentState=t,this.states=e}async send(t){let e=this.currentState,r=t.type,i=this.getTransitionsForEvent(e,r);if(!i)return;let o=Array.isArray(i)?i:[i];for(let s of o)if(s.guard){if(s.guard(t)){s.action&&await s.action(t),s.target&&(this.currentState=s.target);return}}else s.action&&await s.action(t),s.target&&(this.currentState=s.target)}getTransitionsForEvent(t,e){let r=this.states[t];if(r?.on?.[e])return r.on[e];if(r?.on?.["*"])return r.on["*"];let i=this.states["*"];if(i?.on?.[e])return i.on[e];if(i?.on?.["*"])return i.on["*"]}};var Ne=class{tagNames;contentHandler;state="TEXT";scannedText="";tagName=null;tagNamePartial="";kind="open";currentAttributeName="";currentAttributeValue="";attributes={};tagNamePartialIdx=0;potentialTagNameMatches=[];resetPotentialTagStateVars(){this.tagNamePartialIdx=0,this.potentialTagNameMatches=[...this.tagNames],this.tagName=null,this.tagNamePartial="",this.kind="open",this.currentAttributeName="",this.currentAttributeValue="",this.attributes={}}constructor({tagNames:t,contentHandler:e}){this.tagNames=[...t],this.contentHandler=e,this.resetPotentialTagStateVars()}async process(t){for(let e of t){if(this.state==="TEXT")e==="<"&&(this.scannedText.length>0&&(await this.contentHandler({type:"text",text:this.scannedText}),this.scannedText=""),this.state="TAG_START");else if(this.state==="TAG_START")if(e==="/")this.state="TAG_START_SLASH";else if(/^[a-zA-Z0-9]$/.test(e)){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)e!==this.potentialTagNameMatches[r][this.tagNamePartialIdx]&&this.potentialTagNameMatches.splice(r,1);this.potentialTagNameMatches.length===0&&(this.resetPotentialTagStateVars(),this.state="TEXT"),this.state="TAG_NAME",this.tagNamePartial=e,this.kind="open",this.tagNamePartialIdx++}else this.resetPotentialTagStateVars(),this.state="TEXT";else if(this.state==="TAG_START_SLASH")if(/^[a-zA-Z0-9]$/.test(e)){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)e!==this.potentialTagNameMatches[r][this.tagNamePartialIdx]&&this.potentialTagNameMatches.splice(r,1);this.potentialTagNameMatches.length===0&&(this.resetPotentialTagStateVars(),this.state="TEXT"),this.state="TAG_NAME",this.tagNamePartial=e,this.kind="close",this.tagNamePartialIdx++}else this.resetPotentialTagStateVars(),this.state="TEXT";else if(this.state==="TAG_NAME")if(e===" "||e===">"){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)this.tagNamePartialIdx!==this.potentialTagNameMatches[r].length&&this.potentialTagNameMatches.splice(r,1);if(this.potentialTagNameMatches.length===1)if(this.tagName=this.tagNamePartial,e===" ")this.state="WHITESPACE";else if(e===">")this.state="TAG_END";else throw new Error(`Unexpected character: ${e}`);else this.resetPotentialTagStateVars(),this.state="TEXT"}else if(/^[a-zA-Z0-9_-]$/.test(e)){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)e!==this.potentialTagNameMatches[r][this.tagNamePartialIdx]&&this.potentialTagNameMatches.splice(r,1);this.potentialTagNameMatches.length===0&&(this.resetPotentialTagStateVars(),this.state="TEXT"),this.tagNamePartial+=e,this.tagNamePartialIdx++}else this.resetPotentialTagStateVars(),this.state="TEXT";else this.state==="WHITESPACE"?/^[a-zA-Z0-9]$/.test(e)?(this.state="ATTR_NAME",this.currentAttributeName=e):e===" "||(e===">"?this.state="TAG_END":(this.resetPotentialTagStateVars(),this.state="TEXT")):this.state==="ATTR_NAME"?/^[a-zA-Z0-9_-]$/.test(e)?this.currentAttributeName+=e:e===" "?this.state="ATTR_NAME_END":e==="="?this.state="ATTR_EQUAL_FOUND":(this.resetPotentialTagStateVars(),this.state="TEXT"):this.state==="ATTR_NAME_END"?e===" "||(e==="="?this.state="ATTR_EQUAL_FOUND":(this.resetPotentialTagStateVars(),this.state="TEXT")):this.state==="ATTR_EQUAL_FOUND"?e===" "||(e==='"'?(this.state="IN_ATTR_VALUE_DOUBLE_QUOTE",this.currentAttributeValue=""):e==="'"?(this.state="IN_ATTR_VALUE_SINGLE_QUOTE",this.currentAttributeValue=""):(this.resetPotentialTagStateVars(),this.state="TEXT")):this.state==="IN_ATTR_VALUE_DOUBLE_QUOTE"?e==='"'?(this.state="ATTRIBUTE_VALUE_END",this.attributes[this.currentAttributeName]=this.currentAttributeValue,this.currentAttributeName="",this.currentAttributeValue=""):e===">"?(this.resetPotentialTagStateVars(),this.state="TEXT"):this.currentAttributeValue+=e:this.state==="IN_ATTR_VALUE_SINGLE_QUOTE"?e==="'"?(this.state="ATTRIBUTE_VALUE_END",this.attributes[this.currentAttributeName]=this.currentAttributeValue,this.currentAttributeName="",this.currentAttributeValue=""):e===">"?(this.resetPotentialTagStateVars(),this.state="TEXT"):this.currentAttributeValue+=e:this.state==="ATTRIBUTE_VALUE_END"&&(e===" "?this.state="WHITESPACE":e===">"?this.state="TAG_END":(this.resetPotentialTagStateVars(),this.state="TEXT"));this.scannedText+=e,this.state==="TAG_END"&&(await this.contentHandler({type:"tag",name:this.tagName,kind:this.kind,attributes:structuredClone(this.attributes),originalText:this.scannedText}),this.scannedText="",this.resetPotentialTagStateVars(),this.state="TEXT")}this.state==="TEXT"&&this.scannedText.length>0&&(await this.contentHandler({type:"text",text:this.scannedText}),this.scannedText="")}async flush(){this.scannedText.length>0&&(await this.contentHandler({type:"text",text:this.scannedText}),this.scannedText="")}};var _r=["FILESET","FILE","DIFFCHUNK","DIFFOLD","DIFFNEW"],be=class{machine;streamingTagParser;config;fileSet=null;currentFile=null;diffErrors=[];fileStateHasRemovedFirstNewline=!1;diffOldStateHasRemovedFirstNewline=!1;diffOldStateLastCharWasNewline=!1;diffNewStateHasRemovedFirstNewline=!1;diffNewStateLastCharWasNewline=!1;constructor(t){this.config=t,this.streamingTagParser=new Ne({tagNames:_r,contentHandler:e=>this.handlePiece(e)}),this.machine=new Ce({initialState:"IN_TEXT",states:{IN_TEXT:{on:{text:{action:this.renderText.bind(this)},tag:[{guard:e=>e.kind==="open"&&e.name==="FILESET",target:"IN_FILESET",action:this.openFileset.bind(this)}]}},IN_FILESET:{on:{tag:[{guard:e=>e.kind==="close"&&e.name==="FILESET",target:"IN_TEXT",action:this.closeFileset.bind(this)},{guard:e=>e.kind==="open"&&e.name==="FILE",target:"IN_FILE",action:this.openFile.bind(this)}]}},IN_FILE:{on:{text:{guard:e=>e.type==="text",action:this.renderFileText.bind(this)},tag:[{guard:e=>e.kind==="close"&&e.name==="FILE",target:"IN_FILESET",action:this.closeFile.bind(this)},{guard:e=>e.kind==="open"&&e.name==="DIFFCHUNK",target:"IN_DIFFCHUNK",action:this.openDiffChunk.bind(this)}]}},IN_DIFFCHUNK:{on:{tag:[{guard:e=>e.kind==="open"&&e.name==="DIFFNEW",target:"IN_DIFFNEW",action:this.openDiffNew.bind(this)},{guard:e=>e.kind==="open"&&e.name==="DIFFOLD",target:"IN_DIFFOLD",action:this.openDiffOld.bind(this)},{guard:e=>e.kind==="close"&&e.name==="DIFFCHUNK",target:"IN_FILE"}]}},IN_DIFFNEW:{on:{text:{guard:e=>e.type==="text",action:this.renderDiffNewText.bind(this)},tag:[{guard:e=>e.kind==="close"&&e.name==="DIFFNEW",target:"IN_DIFFCHUNK"}]}},IN_DIFFOLD:{on:{text:{guard:e=>e.type==="text",action:this.renderDiffOldText.bind(this)},tag:[{guard:e=>e.kind==="close"&&e.name==="DIFFOLD",target:"IN_DIFFCHUNK"}]}},"*":{on:{"*":{action:e=>{console.log(`Unhandled event: in state "${this.machine.currentState}" and received event "${e.type}".`)}}}}}})}async process(t){await this.streamingTagParser.process(t)}async flush(){await this.streamingTagParser.flush()}hasFileSet(){return this.fileSet!==null}getDiffErrors(){return this.diffErrors}async handlePiece(t){if(t.type==="text")await this.machine.send({type:"text",text:t.text});else if(t.type==="tag")if(t.name==="FILESET")if(t.kind==="open"){let e=t.attributes.FORMAT??"complete";await this.machine.send({type:"tag",name:"FILESET",kind:"open",attributes:{FORMAT:e}})}else await this.machine.send({type:"tag",name:"FILESET",kind:"close"});else if(t.name==="FILE")if(t.kind==="open")if("NAME"in t.attributes){let e=t.attributes.NAME;await this.machine.send({type:"tag",name:"FILE",kind:t.kind,attributes:{NAME:e}})}else console.warn("FILE tag missing required NAME attribute");else await this.machine.send({type:"tag",name:"FILE",kind:"close"});else await this.machine.send({type:"tag",name:t.name,kind:t.kind})}renderText(t){this.config.stream.markdown(t.text)}openFileset(t){let e=t.attributes.FORMAT??"complete";if(e!=="complete"&&e!=="diff")throw new Error(`Invalid fileset format: ${e}`);this.fileSet={format:e,files:[]}}async closeFileset(t){this.config.incrementPreviewCounter();let e="/app-preview-"+this.config.proposedFilePreviewCounter;await this.processFileSetAsync(e)}async processFileSetAsync(t){if(this.fileSet.format==="diff"){for(let r of this.fileSet.files)r.type==="text"&&r.content.endsWith(`
`)&&(r.content=r.content.replace(/\n$/,""));let e=await Ht(this.fileSet,this.config.workspaceFolderUri.fsPath);this.fileSet=e.fileSet,this.diffErrors=e.diffErrors}this.config.proposedFilePreviewProvider.addFiles(this.fileSet.files,t),this.config.stream.button({title:"View changes as diff",command:"shiny.assistant.showDiff",arguments:[this.fileSet,this.config.workspaceFolderUri,t]}),this.config.stream.button({title:"Apply changes",command:"shiny.assistant.saveFilesToWorkspace",arguments:[this.fileSet.files,!0]}),this.config.stream.markdown(new Bt.MarkdownString(`After you apply the changes, press the $(run) button in the upper right of the app.${Re(this.config.projectLanguage)} editor panel to run the app.

`,!0))}openFile(t){if(!this.fileSet)throw new Error("Fileset not initialized");if(this.currentFile={name:t.attributes.NAME,content:"",type:"text"},this.fileSet.files.push(this.currentFile),this.fileStateHasRemovedFirstNewline=!1,this.config.stream.markdown(`
### `+t.attributes.NAME+`
`),this.config.stream.markdown("```"),this.fileSet.format==="diff")this.config.stream.markdown("diff");else{let e=Ut(t.attributes.NAME);e!=="text"&&this.config.stream.markdown(e)}this.config.stream.markdown(`
`)}renderFileText(t){let e=t.text;this.fileSet.format!=="diff"&&(this.fileStateHasRemovedFirstNewline||(e.startsWith(`
`)&&(e=e.slice(1)),this.fileStateHasRemovedFirstNewline=!0),this.currentFile.content+=e,this.config.stream.markdown(e))}closeFile(t){this.currentFile=null,this.config.stream.markdown("```"),this.config.stream.markdown(`
`)}openDiffChunk(t){this.currentFile.content+=`@@ ... @@
`,this.config.stream.markdown(`@@ ... @@
`)}openDiffOld(t){this.diffOldStateHasRemovedFirstNewline=!1,this.diffOldStateLastCharWasNewline=!1}renderDiffOldText(t){let e=t.text;this.diffOldStateLastCharWasNewline&&(e="-"+e),e.endsWith(`
`)?(this.diffOldStateLastCharWasNewline=!0,e=e.slice(0,-1).replaceAll(`
`,`
-`)+`
`):(this.diffOldStateLastCharWasNewline=!1,e=e.replaceAll(`
`,`
-`)),this.diffOldStateHasRemovedFirstNewline||(e.startsWith(`
`)&&(e=e.slice(1)),this.diffOldStateHasRemovedFirstNewline=!0),this.currentFile.content+=e,this.config.stream.markdown(e)}openDiffNew(t){this.diffNewStateHasRemovedFirstNewline=!1,this.diffNewStateLastCharWasNewline=!1}renderDiffNewText(t){let e=t.text;this.diffNewStateLastCharWasNewline&&(e="+"+e),e.endsWith(`
`)?(this.diffNewStateLastCharWasNewline=!0,e=e.slice(0,-1).replaceAll(`
`,`
+`)+`
`):(this.diffNewStateLastCharWasNewline=!1,e=e.replaceAll(`
`,`
+`)),this.diffNewStateHasRemovedFirstNewline||(e.startsWith(`
`)&&(e=e.slice(1)),this.diffNewStateHasRemovedFirstNewline=!0),this.currentFile.content+=e,this.config.stream.markdown(e)}};var lt=_(require("path")),on=_(rn());var jr="assistant-prompts";async function sn(n,t){try{if(!t.language)throw new Error("Project language not set");let e=lt.join(n.extensionPath,jr),r=lt.join(e,"main.md"),i={language:q(t.language),fileExt:Re(t.language),projectSettings:JSON.stringify(t,null,2),verbosity:"Be very concise in the text."};return await on.renderFile(r,{autoEscape:!1,...i})}catch(e){return console.error("Failed to load system prompt:",e),""}}var xt=_(require("path")),se=_(require("vscode"));var oe=_(require("vscode"));var an=require("child_process");async function je({cmd:n,args:t,cwd:e,env:r,stdout:i,stderr:o,timeoutMs:s=1500,verbose:a=!1}){let l=Wr(a,"runShellCommand: ");return new Promise(c=>{let p={stdout:[],stderr:[]},f=(0,an.spawn)(n,t,{cwd:e,env:r,timeout:s});function g(){l("Spawned")}function m(w){l("Error "+w.message),R(),c({status:"error",errorMsgs:w.message,...p})}function S(){l("Close"),R(),c({status:"success",...p})}function E(w){l(`stdout: ${w.toString()}`),p.stdout.push(w.toString()),i&&i(w.toString())}function y(w){l(`stderr: ${w.toString()}`),p.stderr.push(w.toString()),o&&o(w.toString())}function R(){clearTimeout(v),f.off("spawn",g),f.off("error",m),f.off("close",S),f.stdout.off("data",E),f.stderr.off("data",y)}let v=setTimeout(()=>{c({status:"error",errorMsgs:`Command, no response from run command within ${s}ms:
${n} ${t?.join(" ")}`,...p}),R()},s);f.on("spawn",g),f.on("error",m),f.on("close",S),f.stdout.on("data",E),f.stderr.on("data",y)})}function Wr(n,t){return e=>{n&&console.log(t+e)}}var Hr="\x1B[32m",Br="\x1B[0m";async function pe({cmd:n,args:t,cwd:e,env:r,terminal:i,newTerminalName:o,stdout:s,stderr:a,timeoutMs:l=1500,verbose:c=!1}){let p;return i||(oe.window.terminals.forEach(g=>{let m=g.creationOptions;g.name===o&&"pty"in m&&m.pty&&m.pty instanceof We&&g.dispose()}),i=Gr(o)),p=i.creationOptions.pty,i.show(),await p.openedPromise,p.write(`================================================================
`),p.write(`${Hr}Running command: ${JSON.stringify({cmd:n,args:t},void 0,"  ")}${Br}
`),p.write(`
`),{cmdResult:await je({cmd:n,args:t,cwd:e,env:r,stdout:g=>{p.write(g),s&&s(g)},stderr:g=>{p.write(g),a&&a(g)},timeoutMs:l,verbose:c}),terminal:i}}var We=class{writeEmitter;onDidWrite;closeEmitter;onDidClose;openedPromise;openedPromiseResolve;constructor(){this.writeEmitter=new oe.EventEmitter,this.onDidWrite=this.writeEmitter.event,this.closeEmitter=new oe.EventEmitter,this.onDidClose=this.closeEmitter.event,this.openedPromise=new Promise(t=>{this.openedPromiseResolve=t})}write(t){this.writeEmitter.fire(t.replaceAll(`
`,`\r
`))}open(){this.openedPromiseResolve()}close(){this.writeEmitter.dispose(),this.closeEmitter.dispose()}dispose(){this.close()}};function Gr(n){let t=new We,e=oe.window.createTerminal({name:n,pty:t}),r=oe.window.onDidCloseTerminal(function(o){o===e&&(t.dispose(),r.dispose())});return e}var Ln=_(ln()),vt=_(require("fs")),B=require("path"),C=_(require("vscode")),wt=_(Pn());var ft=_(require("http")),Cn=_(require("net")),k=_(require("vscode"));var Rn=_(require("fs")),He=_(require("vscode"));async function _n(n){if(Qr())return await zr(n);let t=He.Uri.parse(`http://localhost:${n}`);return(await He.env.asExternalUri(t)).toString()}var Fn="/usr/lib/rstudio-server/bin/rserver-url";function Qr(){return"RS_SERVER_URL"in process.env?Rn.existsSync(Fn):!1}async function zr(n){let t=await je({cmd:Fn,args:[String(n)]});t.status==="error"&&Error(`Failed to get Posit workbench forwarded port. Error msg:
`+t.errorMsgs);let e=process.env.RS_SERVER_URL,r=process.env.RS_SESSION_URL;if(!e||!r)throw new Error("Can't find URL for workbench.");let i=t.stdout[0];return`${e}${r.slice(1)}p/${i}/`}async function ut(n,t,e=20){let{result:r,cancel:i}=ei(e,t),o,s=new Promise(a=>{o=setTimeout(()=>a(void 0),n)});try{return await Promise.race([r,s])}finally{i(),o&&clearTimeout(o)}}function ei(n,t){let e=!1;async function r(){for(;!e;)try{return await t()}catch{await new Promise(i=>setTimeout(i,n))}throw new Error("Cancelled")}return{result:r(),cancel:()=>{e=!0}}}async function ti(n,t,e=1e3){return new Promise((r,i)=>{let o=new Cn.Socket;o.setTimeout(e),o.connect(t,n,function(){r(!0),o.end()}),o.on("timeout",()=>{o.destroy(),i(new Error("Timed out"))}),o.on("error",s=>{i(s)}),o.on("close",()=>{i(new Error("Connection closed"))})})}async function Be(n,t=1e3){return await ut(t,async()=>{if(await ni(n)===!0)return!0;throw new Error(`Port ${n} is not open yet`)},80)===!0}async function ni(n){let t=ft.createServer(),e=new Promise((r,i)=>{t.on("listening",()=>r(!0)),t.on("error",()=>r(!1))}).finally(()=>{An(t)});return t.listen(n,"127.0.0.1"),e}async function ri(n){return new Promise(t=>{k.window.onDidCloseTerminal(e=>{e===n&&t(!0)})})}function ii(){return k.workspace.getConfiguration().get("shiny.timeoutOpenBrowser",10)*1e3}async function fe(n,t=[],e,r=ii()){if(Nn()==="none")return;let i=await k.window.withProgress({location:k.ProgressLocation.Notification,title:"Waiting for Shiny app to start...",cancellable:!1},async s=>{let a=Date.now(),l=()=>{let f=Date.now(),g=(f-a)/r*100;s.report({increment:g}),a=f},c=[n,...t].map(f=>ut(r,()=>(l(),ti("127.0.0.1",f)))),p=Promise.all(c);return e?Promise.race([p,ri(e)]):p});if(!Array.isArray(i)||e?.exitStatus!==void 0){console.warn("[shiny] Terminal has been closed, will not launch browser");return}if(i.filter(s=>!s).length>0){let s=Math.floor(r/1e3),a=await k.window.showErrorMessage(`Shiny app took longer than ${s}s to start so we have not opened the preview.`,e?"Show Shiny process":"","Keep waiting");if(a==="Keep waiting"){if(e?.exitStatus!==void 0){k.window.showErrorMessage("Shiny terminal was closed, please run the app again.");return}return fe(n,t,e,3e4)}a==="Show Shiny process"&&e?.show(),console.warn("[shiny] Failed to connect to Shiny app, not launching browser");return}let o=await _n(n);await Ge(o)}function Nn(){return k.workspace.getConfiguration().get("shiny.previewType")||"internal"}async function Ge(n){switch(Nn()){case"none":return;case"external":{if(n==="about:blank")return;k.env.openExternal(k.Uri.parse(n));return}case"internal":{let e=Dt();if(e){e(n);return}}default:await k.commands.executeCommand("simpleBrowser.api.open",n,{preserveFocus:!0,viewColumn:k.ViewColumn.Beside})}}async function bn(){do{let n=ft.createServer(),t=new Promise((r,i)=>{n.on("listening",()=>r(n.address().port)),n.on("error",i)}).finally(()=>{An(n)});n.listen(0,"127.0.0.1");let e=await t;if(!oi.includes(e))return e}while(!0)}async function An(n){return new Promise((t,e)=>{n.close(r=>{t()})})}var oi=[1,7,9,11,13,15,17,19,20,21,22,23,25,37,42,43,53,69,77,79,87,95,101,102,103,104,109,110,111,113,115,117,119,123,135,137,139,143,161,179,389,427,465,512,513,514,515,526,530,531,532,540,548,554,556,563,587,601,636,989,990,993,995,1719,1720,1723,2049,3659,4045,5060,5061,6e3,6566,6665,6666,6667,6668,6669,6697,10080];var dt=_(require("vscode"));var kn={};async function Ve(n,t="python"){return dt.workspace.getConfiguration(`shiny.${t}`).get("port")||await On(`app_${n}`)}async function Dn(n){return dt.workspace.getConfiguration("shiny.python").get("autoreloadPort")||await On(`autoreload_${n}`)}async function On(n){let t=kn[n]??0;return t!==0||(t=await bn(),kn[n]=t),t}var In=_(require("vscode")),Un="PYSHINY_EXEC_SHELL";function si(n){let e=(n.creationOptions.env||{})[Un]??"";return/\bcmd\.exe$/i.test(e)?"cmd":/\b(powershell|pwsh).exe$/i.test(e)?"ps":"sh"}function ai(n,t){switch(t){case"cmd":return/\s/.test(n)?n.includes('"')?`"${n.replace(/"/g,'"""')}"`:`"${n}"`:n.replace(/([()%!^"<>&|])/g,"^$1");case"ps":return/[ '"`,;(){}|&<>@#[\]]/.test(n)?`'${n.replace(/'/g,"''")}'`:n;case"sh":return n.replace(/([\\ !"$`&*()|[\]{};<>?])/g,"\\$1");default:throw new Error('Unsupported style. Use "cmd", "ps", or "sh".')}}function ht(n,t,e){let r=si(n),i=[t].concat(...e).filter(o=>o!==null).map(o=>ai(o,r)).join(" ");return r==="ps"&&t?"& "+i:i}function mt(){return{[Un]:In.env.shell}}var gt="Debug Shiny app";async function Mn(){let n=yt();if(!n||!await Bn())return;await Tt();let t=await de();if(!t)return;let e=await Ve("run","python"),r=await Dn("run"),i=await Hn({name:"Shiny",env:{PYSHINY_EXEC_CMD:t,...mt()}}),o=await Promise.all([Be(e),Be(r)]);if(!o[0]){C.window.showErrorMessage(`Unable to open server port ${e}.`);return}if(!o[1]){C.window.showErrorMessage(`Unable to open auto-reload port ${r}.`);return}let s=["-m","shiny","run"];s.push("--port",e+""),s.push("--reload"),s.push("--autoreload-port",r+""),s.push(n);let a=ht(i,t,s);i.sendText(a),await Ge("about:blank"),await new Promise(l=>setTimeout(l,1e3)),process.env.CODESPACES==="true"?await fe(r,[e],i):await fe(e,[r],i)}async function $n(){C.debug.activeDebugSession?.name===gt&&await C.debug.stopDebugging(C.debug.activeDebugSession);let n=yt();if(!n||!await Bn()||(await Tt(),!await de()))return;let e=await Ve("debug","python"),r=C.workspace.getConfiguration("shiny.python").get("debugJustMyCode",!0);await C.debug.startDebugging(void 0,{type:"python",name:gt,request:"launch",module:"shiny",args:["run","--port",e.toString(),n],jinja:!0,justMyCode:r,stopOnEntry:!1})}async function jn(){let n=yt();if(!n)return;await Tt();let t=Ke(n)?(0,B.dirname)(n):n,e=await Ve("run","r"),r=await Hn({name:"Shiny",env:{...mt()}});if(!await Be(e)){C.window.showErrorMessage(`Unable to open server port ${e}.`);return}let i=C.workspace.getConfiguration("shiny.r").get("devmode"),o=li();if(!o)return;let a=[(0,B.join)(o,"rscripts","runShinyApp.R"),t,e+"",i?"--devmode":""],l=await Et("Rscript");if(!l){C.window.showErrorMessage("Could not find R. Is R installed on your system?If R is installed, please make sure your PATH environment variable is configured correctly.");return}let c=ht(r,l,a);r.sendText(c),await Ge("about:blank"),await new Promise(p=>setTimeout(p,1e3)),await fe(e,[],r)}function Wn(n){let{type:t,name:e}=n.configuration,r=n.configuration.args;if(t!=="python"||e!==gt||!r)return;let i=r.indexOf("--port");if(i<0||i===r.length-1)return;let o=r[i+1];if(!/^\d+$/.test(o))return;let s=parseInt(o);s<=0||fe(s).catch(a=>{console.warn("Failed to open browser",a)})}async function Hn(n){if(!n.name)throw new Error("Terminal name is required");let t=C.window.terminals.filter(i=>i.name===n.name),e=C.window.createTerminal(n);e.show(!0);let r=t.map(i=>{let o=new Promise(s=>{let a=C.window.onDidCloseTerminal(function(c){c===i&&(a.dispose(),s())})});return i.dispose(),o});return await Promise.allSettled(r),e}async function Bn(){return C.extensions.getExtension("ms-python.python")?!0:(await C.window.showErrorMessage("The Python extension is required to run Shiny apps. Please install it and try again.","Show Python extension","Not now")==="Show Python extension"&&C.commands.executeCommand("extension.open","ms-python.python"),!1)}async function de(){let n=await Ln.PythonExtension.api(),t=n.environments.getActiveEnvironmentPath(C.window.activeTextEditor?.document.uri),e=await n.environments.resolveEnvironment(t);return e?e.path:(C.window.showErrorMessage('Unable to find Python interpreter. Please use the "Python: Select Interpreter" command, and try again.'),!1)}function yt(){let n=C.window.activeTextEditor?.document.uri.fsPath;if(typeof n!="string"){C.window.showErrorMessage("No active file");return}return n}async function Tt(){C.window.activeTextEditor?.document.isDirty&&await C.window.activeTextEditor?.document.save()}function li(){let n=C.extensions.getExtension("Posit.shiny")?.extensionPath;if(!n){C.window.showErrorMessage("Cannot run Shiny app: failed to locate extension directory");return}return n}async function Et(n){return await ci(n)||pi(n)||ui(n)||await fi(n)||""}async function ci(n){let t=await Ot("r");if(!t)return"";console.log(`[shiny] runtimeMetadata: ${JSON.stringify(t)}`);let e=t.runtimePath;if(!e)return"";let{platform:r}=process,i=r==="win32"?".exe":"";return(0,B.join)((0,B.dirname)(e),n+i)}function pi(n){let{platform:t}=process,e=t==="win32"?".exe":"",r;switch(t){case"win32":r="windows";break;case"darwin":r="mac";break;default:r="linux"}let i=C.workspace.getConfiguration("r.rpath").get(r,void 0);return console.log(`[shiny] rPath: ${i}`),i?(0,B.join)((0,B.dirname)(i),n+e):""}function ui(n="R"){let{platform:t}=process,e=t==="win32"?";":":",r=t==="win32"?".exe":"";if(!process.env.PATH)return"";for(let i of process.env.PATH.split(e)){let o=(0,B.join)(i,n+r);if(vt.existsSync(o))return o}return""}async function fi(n="R"){if(process.platform!=="win32")return"";let t="";try{let e=new wt({hive:wt.HKLM,key:"\\Software\\R-Core\\R"}),r=await new Promise((i,o)=>e.get("InstallPath",(s,a)=>s===null?i(a):o(s)));t=(0,B.join)(r.value,"bin",n+".exe"),t=vt.existsSync(t)?t:""}catch{t=""}return t}var Gn=_(require("vscode"));async function Vn(n,t,e,r){let i=await de();if(!i)return{cmdResult:{status:"error",stdout:[],stderr:[],errorMsgs:"No Python interpreter selected."},terminal:r.terminal,resultString:"No Python interpreter selected."};let o=[];for(let p of r.imports??[])o.push(`import ${p}`);o.push(`
def _parse_arg_json():
    import sys
    import json

    # If the first argument is "-c", then we need to ignore it.
    if sys.argv[0] == "-c":
        json_arg = sys.argv[1]
    else:
        json_arg = sys.argv[0]

    return json.loads(json_arg)
`),o.push("_args = _parse_arg_json()"),o.push(`
_fn = eval(_args["functionName"])
_res = _fn(*_args["args"], **_args["kwArgs"])`),o.push("import json"),o.push("print(json.dumps(_res, indent=2))");let s=["-c",o.join(`
`),JSON.stringify({functionName:n,args:t,kwArgs:e})],a="",l=p=>{a+=p},c=await pe({cmd:i,args:s,cwd:Gn.workspace.workspaceFolders?.[0]?.uri.fsPath,env:r.env,terminal:r.terminal,newTerminalName:r.newTerminalName,stdout:l,stderr:l});return r.terminal=c.terminal,c.cmdResult.status==="error"&&(a+=`
Error running Python function.`),{cmdResult:c.cmdResult,terminal:c.terminal,resultString:a}}var Kn=_(require("vscode"));async function Yn(n,t,e){let r=await Et("Rscript");if(!r)return{cmdResult:{status:"error",stdout:[],stderr:[],errorMsgs:"Could not find R runtime. It seems to not be installed."},terminal:e.terminal,resultString:"Could not find R runtime. It seems to not be installed."};let o=[...(e.scriptPaths??[]).flatMap(c=>["-e",`source("${c}")`]),"-e",".args <- parse_arg_json()","-e",`.res <- do.call(${n}, .args)`,"-e","cat(to_json(.res))",JSON.stringify(t)],s="",a=c=>{s+=c},l=await pe({cmd:r,args:o,cwd:Kn.workspace.workspaceFolders?.[0]?.uri.fsPath,env:e.env,terminal:e.terminal,newTerminalName:e.newTerminalName,stdout:a,stderr:a});return e.terminal=l.terminal,l.cmdResult.status==="error"&&(s+=`
Error running R function.`),{cmdResult:l.cmdResult,terminal:l.terminal,resultString:s}}function he(){let{promise:n,resolve:t,reject:e}=di(),r=!1,i=!1;return{promise:n,resolve(o){r=!0,t(o)},reject(o){i=!0,e(o)},then:n.then.bind(n),catch:n.catch.bind(n),finally:n.finally.bind(n),[Symbol.toStringTag]:"InitStatus",isResolved(){return r},isRejected(){return i},isCompleted(){return r||i}}}function di(){let n,t;return{promise:new Promise((r,i)=>{n=r,t=i}),resolve:n,reject:t}}var me=[];function qn(n){return n instanceof se.LanguageModelToolResult?n:new se.LanguageModelToolResult([new se.LanguageModelTextPart(JSON.stringify(n))])}me.push({name:"shiny-assistant_setProjectLanguageTool",description:"Set the language of the project to R or Python. Only call this tool if the user specifically asks to set the language.",inputSchema:{type:"object",properties:{language:{type:"string",enum:["r","python"],description:"Programming language to use for the project"}},required:["language"]},invoke:({language:n},t)=>(t.stream.markdown(`

Setting project language to ${q(n)}...

`),U.language=n,`The project language has been set to ${q(n)}`)});me.push({name:"shiny-assistant_askUserForAppSubdirTool",description:"Ask the user which subdirectory of the workspace they want to use for their app.",inputSchema:{type:"object",properties:{defaultDir:{type:"string",description:'Default subdirectory to display to the user. For example, "./" or "myapp/". It should not have a leading slash.'}},required:["language"]},invoke:async({defaultDir:n},t)=>{let e;n==="./"?e="top level directory":e=`\`${n}\` subdirectory`,t.stream.markdown(`

Would you like to put your app in the ${e} of the project workspace?

`);let r=he();return t.stream.button({title:`Yes, use ${n}`,command:"shiny.assistant.setAppSubdir",arguments:[n,i=>{i&&r.resolve()}]}),t.stream.button({title:"No, I want to choose another subdirectory",command:"shiny.assistant.setAppSubdir",arguments:[null,i=>{i&&r.resolve()}]}),await r,t.stream.markdown(`You have set the app subdirectory to \`${U.appSubdir}/\`.

`),`User has set app subdirectory to: ${U.appSubdir}/.

`}});me.push({name:"shiny-assistant_checkPackageVersionTool",description:"Get the version of an R or Python package that is installed on the user's system.",inputSchema:{type:"object",properties:{language:{type:"string",enum:["r","python"],description:"Programming language that Shiny is being used with"},package:{type:"string",description:"Name of package to check the version of"},minVersion:{type:"string",description:"Minimum version of the package required"}},required:["language","package"]},invoke:async({language:n,package:t,minVersion:e},r)=>{r.stream.markdown(`

Checking version of ${t} for ${q(n)}...

`);let i;if(n==="r")i=await hi("check_package_version",{package:t,min_version:e??null},{extensionContext:r.extensionContext,env:{},terminal:r.terminal,newTerminalName:r.newTerminalName});else if(n==="python")i=await mi("tools.check_package_version",[],{package:t,min_version:e??null},{extensionContext:r.extensionContext,env:{},terminal:r.terminal,newTerminalName:r.newTerminalName});else return`Invalid language: ${n}`;r.terminal=i.terminal;let o=i.resultString;return i.cmdResult.status==="error"&&(o+=`
Error getting version of ${t}.`),o}});me.push({name:"shiny-assistant_installRequiredPackagesTool",description:"Installs necessary packages, for Python only.",inputSchema:{type:"object",properties:{language:{type:"string",enum:["r","python"],description:"Programming language that Shiny is being used with"}},required:["language"]},invoke:async({language:n},t)=>{let e,r=[],i="",o=se.workspace.workspaceFolders;if(!(o&&o.length>0))return"No workspace folder found.";let s=o[0].uri.fsPath;if(t.stream.markdown(`

Installing required packages...

`),n==="r")return"Installing R packages is not supported yet.";if(n==="python"){if(e=await de(),!e)return"No Python interpreter selected";r=["-m","pip","install","-r","requirements.txt"]}else return`Invalid language: ${n}`;i=`Running command: 
\`\`\`
${e} ${r.join(" ")}
\`\`\`

`,t.stream.markdown(i),t.stream.progress("Running...");let a=await pe({cmd:e,args:r,cwd:s,terminal:t.terminal,newTerminalName:t.newTerminalName,timeoutMs:15e3,stdout:l=>{i+=l},stderr:l=>{i+=l}});return t.terminal=a.terminal,a.cmdResult.status==="error"&&(i+="Error installing packages."),i}});async function hi(n,t,e){let{extensionContext:r,...i}=e,o={...i,scriptPaths:[xt.join(r.extensionPath,"assistant-prompts","tools.R")]};return await Yn(n,t,o)}async function mi(n,t,e,r){let{extensionContext:i,env:o,...s}=r,a={...o};a.PYTHONPATH=xt.join(i.extensionPath,"assistant-prompts")+(o.PYTHONPATH?`:${o.PYTHONPATH}`:"");let l={...s,env:a,imports:["tools"]};return await Vn(n,t,e,l)}var Pt=new _e,Jn=0,Zn="Proposed changes",xe=[],U={language:null,appSubdir:null},St=he(),Qn=he(),Xn=new d.CancellationTokenSource().token;function zn(n){Rt(),xe.push(d.commands.registerCommand("shiny.assistant.saveFilesToWorkspace",er),d.commands.registerCommand("shiny.assistant.applyChangesToWorkspaceFromDiffView",vi),d.commands.registerCommand("shiny.assistant.showDiff",wi),d.commands.registerCommand("shiny.assistant.setProjectLanguage",(t,e)=>{U.language=t,e()}),d.commands.registerCommand("shiny.assistant.continueAfterDesiredModelSuggestion",t=>St.resolve(t)),d.commands.registerCommand("shiny.assistant.continueAfterWorkspaceFolderSuggestion",()=>Qn.resolve()),d.commands.registerCommand("shiny.assistant.setAppSubdir",Ti),d.workspace.registerTextDocumentContentProvider("proposed-files",Pt),gi(n)),xe.forEach(t=>n.subscriptions.push(t))}function Rt(){xe.length!==0&&(xe.forEach(n=>n.dispose()),xe.length=0)}function gi(n){let t=async(r,i,o,s)=>{let a={metadata:{command:void 0,followups:[],rawResponseText:""}};if(r.command==="start")return o.markdown(`Shiny Assistant can help you with building and deploying Shiny applications. You can ask me to:

  - Create a Shiny app
  - Modify an existing Shiny app
  - Install packages needed for your app
  - Troubleshoot a Shiny app

You can also ask me to explain the code in your Shiny app, or to help you with any other questions you have about Shiny.
        `),a.metadata.followups.push("Create a simple Shiny app."),a.metadata.followups.push("Install the packages needed for my app."),a;if(!Lt(r.model)&&!St.isResolved()&&(Mt(r.model.name,o),await St))return o.markdown(new d.MarkdownString(`Great! In the chat input box down below, switch to ${ye()}and then click on the $(refresh) button.

`,!0)),a;let l=d.workspace.workspaceFolders?.[0];if(!l&&(o.markdown(`You currently do not have an active workspace folder. You need an active workspace folder to use Shiny Assistant.

`),o.markdown(`Please open a folder by clicking on the **Open Folder** button in the sidebar, or by clicking on the **File** menu and then **Open Folder...** 

`),o.button({title:"Got it, continue",command:"shiny.assistant.continueAfterWorkspaceFolderSuggestion"}),await Qn,l=d.workspace.workspaceFolders?.[0],!l))return o.markdown(`I'm sorry, I can't continue without an active workspace folder.

`),a;let c=l.uri,p=r.references.find(u=>(u.id==="vscode.implicit.viewport"||u.id==="vscode.implicit.selection")&&u.value instanceof d.Location&&u.value.uri.scheme==="file"),f=p?W.relative(c.fsPath,p.value.uri.fsPath):void 0;if(f&&!f.match("/")&&(f="./"+f),f){let u=W.basename(f),P;u.toLowerCase().endsWith(".r")?P="r":u.toLowerCase().endsWith(".py")?P="python":P="other",P!=="other"&&U.language!==P&&(U.language=P,o.markdown(`Based on the current file \`${f}\`, I see you are using ${q(U.language)}.

`))}if(U.language===null){o.markdown(`What language do you want to use for your Shiny app?

`);let u=he();o.button({title:"I'm using R",command:"shiny.assistant.setProjectLanguage",arguments:["r",u.resolve]}),o.button({title:"I'm using Python",command:"shiny.assistant.setProjectLanguage",arguments:["python",u.resolve]}),await u,o.progress("")}if(f&&H(f,U.language)){let u=W.dirname(f);U.appSubdir!==u&&(U.appSubdir=u,o.markdown(`Based on the current file \`${f}\`, the app subdirectory has been set to \`${U.appSubdir}/\`.

`),o.progress(""))}let g=i.history.map(u=>{if(u instanceof d.ChatRequestTurn)return d.LanguageModelChatMessage.User(u.prompt);if(u instanceof d.ChatResponseTurn){let P="";return u.result.metadata?.rawResponseText?P=u.result.metadata.rawResponseText:u.response.forEach(T=>{T instanceof d.ChatResponseMarkdownPart&&(P+=T.value.value)}),d.LanguageModelChatMessage.Assistant(P)}throw new Error(`Unknown message type in chat history: ${u}`)}),m=await sn(n,U);g.unshift(d.LanguageModelChatMessage.User(m));let S=[...r.references];if(p){let u=p.value.uri,P={id:u.toString(),range:void 0,modelDescription:"file:"+W.basename(f),value:u};S.push(P)}let E=await Ei(S,c);g.push(d.LanguageModelChatMessage.User(E.join(`
`))),g.push(d.LanguageModelChatMessage.User(r.prompt));let y=[...me,...d.lm.tools],R=[...r.toolReferences];y=y.filter(u=>u.description!=="");let v=!1,w="";async function h(){let u={},P=R.shift();P?(u.toolMode=d.LanguageModelChatToolMode.Required,u.tools=y.filter(T=>T.name===P.name)):(u.toolMode=d.LanguageModelChatToolMode.Auto,u.tools=y);try{let T=await r.model.sendRequest(g,u,s),N=[],b=[],Y="",G=new be({stream:o,workspaceFolderUri:c,proposedFilePreviewProvider:Pt,proposedFilePreviewCounter:Jn,incrementPreviewCounter:()=>++Jn,projectLanguage:U.language});for await(let O of T.stream)O instanceof d.LanguageModelTextPart?(w+=O.value,Y+=O.value,await G.process(O.value)):O instanceof d.LanguageModelToolCallPart?N.push(O):console.log("Unknown part type: ",O);if(await G.flush(),b=G.getDiffErrors(),v=v||G.hasFileSet(),g.push(d.LanguageModelChatMessage.Assistant([new d.LanguageModelTextPart(Y),...N])),b.length>0&&(o.markdown(`The following errors occurred while applying the diff:

`),o.markdown(b.map(O=>O.message).join(`

`))),N.length>0){let O=[];for(let L of N){let V=y.find(le=>le.name===L.name);if(!V){console.log(`Tool not found: ${L.name}`);continue}let ae;if("invoke"in V){let le=await V.invoke(L.input,{stream:o,newTerminalName:"Shiny Assistant tool calls",terminal:void 0,extensionContext:n,cancellationToken:Xn});if(le===void 0){console.log(`Tool returned undefined: ${L.name}`);continue}ae=qn(le)}else ae=await d.lm.invokeTool(V.name,{input:L.input,toolInvocationToken:r.toolInvocationToken},Xn);let j=new d.LanguageModelToolResultPart(L.callId,ae.content);O.push(j)}return g.push(d.LanguageModelChatMessage.User(O)),g.push(d.LanguageModelChatMessage.User("The messages above contain the results from one or more tool calls. The user can't see these results, so you should explain to the user if you reference them in your response.")),o.markdown(`

`),o.progress(""),w+=`

`,await h()}}catch(T){let N=null;if(T instanceof Error){if(!we()){let b=Si(T);if(b&&b.error.code==="model_not_supported"){b.error.message==="The requested model is not supported."?(o.markdown(`The requested model, ${r.model.name} is not enabled. You can enable it at [https://github.com/settings/copilot](https://github.com/settings/copilot). Scroll down to **Anthropic Claude 4 Sonnet in Copilot** and set it to **Enable**.

`),o.markdown(`Or you can send another message in this chat without \`@shiny\`, like \`"Hello"\`, and Copilot will ask you if you want to enable ${r.model.name}. After you enable it, remember to start the next message with \`@shiny\` again.

`),o.markdown("After enabling the model, you may need to reload this window or restart VS Code to use it.")):b.error.message==="Model is not supported for this request."?o.markdown(`The requested model, ${r.model.name} does not accept requests for Chat Participants, like \`@shiny\`. Please use a different model.`):o.markdown(`An error occurred while processing the response from the language model: ${T.message}.`);return}}N=T.message}o.markdown(`An error occurred while processing the response from the language model: ${N??T}.`)}}return await h(),a.metadata.rawResponseText=w,v&&a.metadata.followups.push("Install the packages needed for my app."),a},e=d.chat.createChatParticipant("chat.shiny-assistant",t);return e.followupProvider={provideFollowups:(r,i,o)=>r.metadata.followups.map(a=>typeof a=="string"?{prompt:a,command:""}:a)},e.iconPath=d.Uri.joinPath(n.extensionUri,"images/assistant-icon.svg"),e}async function vi(){return await er(tr,!0)}async function er(n,t=!1){let e=d.workspace.workspaceFolders?.[0]?.uri;if(!e)return d.window.showErrorMessage("You currently do not have an active workspace folder. Please open a workspace folder and try again."),!1;t&&await yi();try{let r=[],i=[],o=new d.WorkspaceEdit;for(let a of n){if(a.type==="binary")return d.window.showErrorMessage(`Failed to handle file ${a.name}: Binary files are not supported at this time.`),!1;let l=d.Uri.joinPath(e,a.name);try{await d.workspace.fs.stat(l);let c=await d.workspace.openTextDocument(l);c.getText()!==a.content&&(o.set(l,[d.TextEdit.replace(new d.Range(c.positionAt(0),c.positionAt(c.getText().length)),a.content)]),r.push(l))}catch{o.createFile(l,{overwrite:!1,contents:Buffer.from(a.content,"utf-8")}),i.push(l)}}await d.workspace.applyEdit(o);let s=null;for(let a of[...r,...i]){let l=await d.workspace.openTextDocument(a);["app.R","app.py"].includes(W.basename(a.fsPath))&&(s=l),await d.window.showTextDocument(l,{preserveFocus:!1}),await d.workspace.save(a)}return s&&await d.window.showTextDocument(s,{preserveFocus:!1}),!0}catch(r){return r instanceof Error&&d.window.showErrorMessage(`Failed to handle files: ${r.message}`),!1}}var tr=[];async function wi(n,t,e){if(!t)return d.window.showErrorMessage("You currently do not have an active workspace folder. Please open a workspace folder and try again."),!1;tr=n.files;try{Pt?.addFiles(n.files);let r=[];for(let i of n.files){let o=d.Uri.joinPath(t,i.name),s;try{if(await d.workspace.fs.stat(o),(await d.workspace.openTextDocument(o)).getText()===i.content)continue;s=o}catch{s=d.Uri.parse(`proposed-files://empty/${i.name}`)}let a=d.Uri.parse(`proposed-files://${e}/${i.name}`);r.push([d.Uri.parse("dummy-scheme://unused-label"),s,a])}return await d.commands.executeCommand("vscode.changes",Zn,r),!0}catch(r){return console.error("Error showing diff:",r),!1}}async function yi(){let t=d.window.tabGroups.all.flatMap(e=>e.tabs).filter(e=>e.isPreview&&e.label.startsWith(Zn));for(let e of t)await d.window.tabGroups.close(e)}async function Ti(n,t){if(n===null){let e={canSelectFiles:!1,canSelectFolders:!0,canSelectMany:!1,openLabel:"Select App Directory",title:"Select Shiny App Directory"},r=await d.window.showOpenDialog(e);if(r&&r.length>0){let i=d.workspace.workspaceFolders[0].uri.fsPath,o=W.relative(i,r[0].fsPath);U.appSubdir=o,t(!0)}else t(!1)}else n=n.replace(/^\/|\/$/g,""),U.appSubdir=n,t(!0)}async function Ei(n,t){return Promise.all(n.map(e=>xi(e,t)))}async function xi(n,t){let e=n.value;if(e instanceof d.Uri){let r=W.relative(t.fsPath,e.fsPath),i=(await d.workspace.fs.readFile(e)).toString();return`
<context>
${r}:
\`\`\`
${i}
\`\`\`
</context>
`}else if(e instanceof d.Location){let r=W.relative(t.fsPath,e.uri.fsPath),i=(await d.workspace.openTextDocument(e.uri)).getText(e.range);return`
<context>
${r}:${e.range.start.line+1}-${e.range.end.line+1}:
\`\`\`
${i}
\`\`\`
</context>
`}else{if(typeof e=="string")return`
<context>
${e}
</context>
`;throw new Error("Unsupported value type for context block.")}}function Si(n){let t="",e="",r=n.message.indexOf("{");r!==-1&&(t=n.message.substring(0,r),e=n.message.substring(r));let i=parseInt(t.match(/\d+/)?.[0]||"-1");if(e)try{let o=JSON.parse(e);if(o&&typeof o=="object"&&"error"in o&&typeof o.error=="object"&&"message"in o.error&&typeof o.error.message=="string"&&"param"in o.error&&typeof o.error.param=="string"&&"code"in o.error&&typeof o.error.code=="string"&&"type"in o.error&&typeof o.error.type=="string")return{summary:t,code:i,error:o.error}}catch{}return null}var dr=require("url"),K=_(require("vscode"));var ir=_(require("path"),1);var Pi=["Dockerfile","Makefile","Rakefile","ada","adb","ads","applescript","as","ascx","asm","asmx","asp","aspx","atom","bas","bash","bashrc","bat","bbcolors","bdsgroup","bdsproj","bib","bowerrc","c","cbl","cc","cfc","cfg","cfm","cfml","cgi","clj","cls","cmake","cmd","cnf","cob","coffee","coffeekup","conf","cpp","cpt","cpy","crt","cs","csh","cson","csr","css","csslintrc","csv","ctl","curlrc","cxx","dart","dfm","diff","dockerignore","dof","dpk","dproj","dtd","eco","editorconfig","ejs","el","emacs","eml","ent","erb","erl","eslintignore","eslintrc","ex","exs","f","f03","f77","f90","f95","fish","for","fpp","frm","ftn","gemrc","gitattributes","gitconfig","gitignore","gitkeep","gitmodules","go","gpp","gradle","groovy","groupproj","grunit","gtmpl","gvimrc","h","haml","hbs","hgignore","hh","hpp","hrl","hs","hta","htaccess","htc","htm","html","htpasswd","hxx","iced","inc","ini","ino","int","irbrc","itcl","itermcolors","itk","jade","java","jhtm","jhtml","js","jscsrc","jshintignore","jshintrc","json","json5","jsonld","jsp","jspx","jsx","ksh","less","lhs","lisp","log","ls","lsp","lua","m","mak","map","markdown","master","md","mdown","mdwn","mdx","metadata","mht","mhtml","mjs","mk","mkd","mkdn","mkdown","ml","mli","mm","mxml","nfm","nfo","njk","noon","npmignore","npmrc","nvmrc","ops","pas","pasm","patch","pbxproj","pch","pem","pg","php","php3","php4","php5","phpt","phtml","pir","pl","pm","pmc","pod","pot","properties","props","pt","pug","py","r","rake","rb","rdoc","rdoc_options","resx","rhtml","rjs","rlib","rmd","ron","rs","rss","rst","rtf","rvmrc","rxml","s","sass","scala","scm","scss","seestyle","sh","shtml","sls","spec","sql","sqlite","ss","sss","st","strings","sty","styl","stylus","sub","sublime-build","sublime-commands","sublime-completions","sublime-keymap","sublime-macro","sublime-menu","sublime-project","sublime-settings","sublime-workspace","sv","svc","svg","t","tcl","tcsh","terminal","tex","text","textile","tg","tmLanguage","tmTheme","tmpl","toml","tpl","ts","tsv","tsx","tt","tt2","ttml","txt","v","vb","vbs","vh","vhd","vhdl","vim","viminfo","vimrc","vue","webapp","wxml","wxss","x-php","xaml","xht","xhtml","xml","xs","xsd","xsl","xslt","yaml","yml","zsh","zshrc"],nr=Pi;var Ri=["dds","eot","gif","ico","jar","jpeg","jpg","pdf","png","swf","tga","ttf","zip"],rr=Ri;function _i(n,t){if(n){let e=ir.basename(n).split(".").reverse();for(let r of e){if(nr.indexOf(r)!==-1)return!0;if(rr.indexOf(r)!==-1)return!1}}return t?Ye(t)==="utf8":null}function or(n,t){let e=_i(n,t);return e==null?null:!e}function Ye(n,t){var e,r;if(!n)return null;let i="utf8",o="binary",s=(e=t?.chunkLength)!==null&&e!==void 0?e:24,a=(r=t?.chunkBegin)!==null&&r!==void 0?r:0;if(t?.chunkBegin==null){let l=Ye(n,{chunkLength:s,chunkBegin:a});return l===i&&(a=Math.max(0,Math.floor(n.length/2)-s),l=Ye(n,{chunkLength:s,chunkBegin:a}),l===i&&(a=Math.max(0,n.length-s),l=Ye(n,{chunkLength:s,chunkBegin:a}))),l}else{if(a=Fi(n,a),a===-1)return o;let l=Ci(n,Math.min(n.length,a+s));if(l>n.length)return o;let c=n.toString(i,a,l);for(let p=0;p<c.length;++p){let f=c.charCodeAt(p);if(f===65533||f<=8)return o}return i}}function Fi(n,t){if(t===0)return 0;if(!Ni(n[t]))return t;let e=t-3;return e>=0&&ge(n[e])||(e=t-2,e>=0&&(ge(n[e])||qe(n[e])))||(e=t-1,e>=0&&(ge(n[e])||qe(n[e])||sr(n[e])))?e:-1}function Ci(n,t){if(t===n.length)return t;let e=t-3;if(e>=0&&ge(n[e]))return t+1;if(e=t-2,e>=0){if(ge(n[e]))return t+2;if(qe(n[e]))return t+1}if(e=t-1,e>=0){if(ge(n[e]))return t+3;if(qe(n[e]))return t+2;if(sr(n[e]))return t+1}return t}function ge(n){return n>>3===30}function qe(n){return n>>4===14}function sr(n){return n>>5===6}function Ni(n){return n>>6===2}var Xe=_(ar()),$=_(require("path")),x=_(require("vscode"));async function lr(){if(!x.window.activeTextEditor){x.window.showErrorMessage("Shinylive: no editor is currently active.");return}let n=x.window.activeTextEditor.document.getText(),{fileName:t,languageId:e,isUntitled:r}=x.window.activeTextEditor.document;if(!e||!["r","python"].includes(e)){x.window.showErrorMessage("Shinylive only supports Python and R apps.");return}if(!r){let{name:s}=$.parse(t);if(!/(^app|app$)/i.test(s)){x.window.showErrorMessage("Shinylive: A single-file Shiny app is required when creating a link from the active editor.");return}}let i=e==="r"?"R":"py",o=[{name:`app.${i}`,content:n,type:"text"}];await cr(o,i.toLowerCase())}async function cr(n,t="py"){let e=await ki();if(!e)return;let r=Ft({language:t,files:n,mode:e}),i=await Ai();if(i)return i==="open"?x.env.openExternal(x.Uri.parse(r)):(await x.env.clipboard.writeText(r),x.window.showInformationMessage("Copied shinylive link to clipboard!")),r}async function Ze(n){if(typeof n>"u"&&(n=await Di()),!n)return;let t=Ct(n);if(!t){x.window.showErrorMessage("Shinylive: Failed to parse the Shinylive link. Please check the link and try again.");return}let{files:e,language:r}=t;if(e.length<1){x.window.showErrorMessage("Shinylive: The provided link did not contain any files.");return}if(bi(e))return;let i=e.length===1,o;if(i){let l=await Oi(e[0].name);l&&(e[0].name=$.basename(l.path),o=l.with({path:$.dirname(l.path)}))}else o=await Ii();if(!o)return;let s=await Ui(e,o,e.length>1);if(s.length===0)return;let a=await x.workspace.openTextDocument(s[0]);await x.window.showTextDocument(a,void 0,!1)}function bi(n){let t=n.map(e=>e.name).filter(e=>e.startsWith(".."));return t.length&&x.window.showErrorMessage("Shinylive link includes files that cannot be written into a single, contained directory, e.g. '"+t[0]+"'. Please edit the file paths on Shinylive and try again."),t.length>0}async function pr(n,t){let e=[];for(let p of t){let f=await ur(p);f&&e.push(...f)}let r=e.filter((p,f,g)=>f===g.findIndex(m=>m.fsPath===p.fsPath)).sort((p,f)=>{let g=H(p.path,"python")||H(p.path,"r"),m=H(f.path,"python")||H(f.path,"r");return-g+ +m}),i=r[0].path,o=H(i,"python"),s=H(i,"r");if(!o&&!s){x.window.showErrorMessage("Shinylive: the selected files did not contain a Shiny for Python or R app.");return}let a=$.dirname(i),l=p=>$.relative(a,p.path),c=await Promise.all(r.map(async p=>{let f=or(p.fsPath)?"binary":"text",g=l(p);p.path===i&&(o?g="app.py":s&&g.indexOf("app")>=0&&(g="app.R"));let m=await x.workspace.fs.readFile(p),S=f==="binary"?Buffer.from(m).toString("base64"):Buffer.from(m).toString();switch(f){case"binary":return{name:g,content:S,type:f};default:return{name:g,content:S}}}));await cr(c,o?"py":"r")}async function ur(n){if((await x.workspace.fs.stat(n)).type!==x.FileType.Directory)return[n];if(["_","."].some(i=>$.basename(n.path).startsWith(i)))return;let e=[],r=await x.workspace.fs.readDirectory(n);for(let[i,o]of r)if(o===x.FileType.Directory){let s=x.Uri.file(`${n.path}/${i}`),a=await ur(s);a&&e.push(...a)}else e.push(x.Uri.file(`${n.path}/${i}`));return e}async function Ai(){let n=x.workspace.getConfiguration("shiny.shinylive").get("openAction")||"ask";if(["open","copy"].includes(n))return n;let t=await x.window.showQuickPick(["open","copy"],{title:"Open or copy the ShinyLive link?"});return t||""}async function ki(){let n=x.workspace.getConfiguration("shiny.shinylive").get("appMode")||"ask";if(["app","editor"].includes(n))return n;let t=[{label:"app",detail:"App mode displays only the app on Shinylive."},{label:"editor",detail:"Editor mode displays the app alongside an editor and console."}],e=await x.window.showQuickPick(t,{title:"Which Shinylive mode?"});return e?e.label:""}async function Di(){return await x.window.showInputBox({title:"Enter or paste a Shinylive link"})||""}var ve;async function Oi(n){let t=ve||x.workspace.workspaceFolders?.[0].uri,e=x.Uri.joinPath(t,n),r=await x.window.showSaveDialog({defaultUri:e,saveLabel:"App file",title:"Choose a path for the Shinylive app",filters:n?n.endsWith(".py")?{Python:["py"]}:{R:["R","r"]}:void 0});if(!r){ve=t||x.Uri.file(".");return}return ve=r.with({path:$.dirname(r.path)}),r}async function Ii(){let n=ve||x.workspace.workspaceFolders?.[0].uri,t=await x.window.showSaveDialog({defaultUri:n,saveLabel:"App directory",title:"Choose a directory for the Shinylive app and files"});if(!t){ve=n||x.Uri.file(".");return}if(t.scheme!=="file"){x.window.showErrorMessage("Shinylive: Remote directories are not supported at this time. Please save the app locally instead.");return}try{await x.workspace.fs.createDirectory(t)}catch(e){x.window.showErrorMessage(`Shinylive failed to create new directory "${t.toString()}". ${e}`);return}return ve=t,t}function Ft({language:n,files:t,mode:e}){let r=JSON.stringify(t),i=Xe.compressToEncodedURIComponent(r),o=x.workspace.getConfiguration("shiny.shinylive").get("host"),s;return e==="app"&&(s=x.workspace.getConfiguration("shiny.shinylive").get("includeHeader")),`${o}/${n}/${e}/#${s?"":"h=0&"}code=${i}`}function Ct(n){let{hash:t,pathname:e}=new URL(n),{searchParams:r}=new URL("https://shinylive.io/?"+t.substring(1)),i=r.get("code");if(!i)return;let o=Xe.decompressFromEncodedURIComponent(i),s=JSON.parse(o).map(p=>(p.name=$.normalize(p.name),p)),a=e.split("/"),l=a.includes("py")?"py":"r",c=a.includes("editor")?"editor":"app";return{language:l,mode:c,files:s}}async function Ui(n,t,e=!0){let r=[];for(let i of n){let o=x.Uri.joinPath(t,i.name),s=o.with({path:$.dirname(o.path)});if(s.scheme==="file"&&!await fr(s))try{await x.workspace.fs.createDirectory(s)}catch(l){return x.window.showErrorMessage(`Shinylive failed to create directory "${s.toString()}". ${l}`),[]}let a;switch(i.type){case"binary":a=Buffer.from(i.content,"base64");break;default:a=Buffer.from(i.content,"utf8");break}if(!e||await Li(o))try{await x.workspace.fs.writeFile(o,a),r.push(o)}catch(l){return x.window.showErrorMessage(`Shinylive failed to write file ${i.name} to "${o.toString()}". ${l}`),[]}}return r}async function Li(n){return n.scheme!=="file"||!await fr(n)?!0:await x.window.showInformationMessage(`File exists, overwrite? "${n.fsPath}"`,"Yes","No")==="Yes"}async function fr(n){try{return typeof(await x.workspace.fs.stat(n)).type<"u",!0}catch{return!1}}async function hr(n){if(!["/shinylive","/shinylive/"].includes(n.path)){console.warn(`[shiny] Unexpected URI: ${n.toString()}`);return}let t=new dr.URLSearchParams(n.query).get("url");if(!t){K.window.showErrorMessage("No URL provided in the Open from Shinylive link.");return}let e=decodeURIComponent(t),r=Ct(e);if(!r){K.window.showErrorMessage("Shinylive: Failed to parse the Shinylive link. Please check the link and try again.");return}let i=r.files.slice(0,3).map(a=>a.name).join(", ");r.files.length>3&&(i+=`, and ${r.files.length-3} more files`);let o=await K.window.showWarningMessage(`You are about to save a Shinylive app with ${i} to your workspace. Would you like to...`,{modal:!0},{title:"Review the app on shinylive.io",action:"review"},{title:`Save app ${r.files.length===1?"file":"files"} locally`,action:"save"}),{action:s}=o||{action:"cancel"};if(s!=="cancel"){if(s==="review"){r.mode="editor";let a=Ft(r);if(K.env.openExternal(K.Uri.parse(a)),!await K.window.showInformationMessage("After reviewing the Shinylive app, would you like to save it?",{modal:!0},"Yes"))return;s="save"}if(s==="save"){await Ze(e);return}}}async function Mi(n){console.log("Activating Shiny extension"),n.subscriptions.push(D.commands.registerCommand("shiny.python.runApp",Mn),D.commands.registerCommand("shiny.python.debugApp",$n),D.commands.registerCommand("shiny.r.runApp",jn),D.commands.registerCommand("shiny.shinylive.createFromActiveEditor",lr),D.commands.registerCommand("shiny.shinylive.saveAppFromUrl",Ze),D.commands.registerCommand("shiny.shinylive.createFromExplorer",pr),D.window.registerUriHandler({async handleUri(e){await hr(e)}})),zn(n);let t=new Nt(2e3,()=>{mr("python"),mr("r")});n.subscriptions.push(t),n.subscriptions.push(D.window.onDidChangeActiveTextEditor(t.immediateCall.bind(t))),n.subscriptions.push(D.workspace.onDidChangeTextDocument(e=>{D.window.activeTextEditor?.document===e.document&&t.normalCall()})),t.immediateCall(),D.debug.onDidStartDebugSession(Wn)}function $i(){Rt()}function mr(n){let t=`shiny.${n}.active`,e=D.window.activeTextEditor;if(!e)return D.commands.executeCommand("setContext",t,!1),!1;let r=e.document.languageId===n&&!e.document.isUntitled&&!!e.document.fileName&&H(e.document.fileName,n)&&e.document.getText().search(/\bshiny\b/)>=0;return D.commands.executeCommand("setContext",t,r),r}var Nt=class{_thresholdMillis;_callback;_timeout;_pending;constructor(t,e){this._thresholdMillis=t,this._callback=e,this._timeout=null,this._pending=!1}normalCall(){this._timeout?this._pending=!0:this._invoke()}immediateCall(){this._invoke()}_invoke(){this._clearTimer(),this._pending=!1;try{this._callback()}finally{this._timeout=setTimeout(()=>{this._clearTimer(),this._pending&&this._invoke()},this._thresholdMillis)}}_clearTimer(){this._timeout&&(clearTimeout(this._timeout),this._timeout=null)}dispose(){this._clearTimer(),this._pending=!1}};function H(n,t){n=bt.basename(n);let e={python:"py",r:"R"}[t];if(!new RegExp(`\\.${e}$`,"i").test(n))return!1;let r=new RegExp(`^app\\.${e}$`,"i"),i=new RegExp(`^app[-_].+\\.${e}$`,"i"),o=new RegExp(`[-_]app\\.${e}$`,"i");return r.test(n)||i.test(n)||o.test(n)?!0:t==="r"?Ke(n):!1}function Ke(n){return n=bt.basename(n),["ui.r","server.r","global.r"].includes(n.toLowerCase())}0&&(module.exports={activate,deactivate,isShinyAppFilename,isShinyAppRPart});
